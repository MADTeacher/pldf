---
description: Этап 3.5: Планирование деплоя — договориться где и как будет развернута система (окружения, CI/CD, секреты, наблюдаемость)
handoffs:
  - label: Создать план реализации
    agent: pldf.plan
    prompt: Создай план реализации, учитывая решения из deployment.md (CI/CD, окружения, миграции, секреты, observability)
scripts:
  sh:
  ps:
---

## Пользовательский ввод

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учитывать пользовательский ввод перед продолжением (если он не пустой).

## Правила диалога со студентом (обязательно)

- **Задавай вопросы строго по одному**: в каждом твоем сообщении должен быть **ровно 1 вопрос**, который требует ответа студента.
- **Не выдавай список вопросов заранее** (никаких длинных анкет/чек-листов вопросов за раз).
- Если нужен выбор, задай **один вопрос** и предложи **не больше 3–5 вариантов** (или попроси свободный ответ).
- **Дожидайся ответа** и только затем задавай следующий вопрос.
- Если ответ неполный — задай **один уточняющий вопрос**, а не несколько сразу.

## Описание

Эта команда фиксирует договоренности о **развертывании и эксплуатации** системы: где она будет работать, как ее собирать и выкатывать, какие окружения нужны, как управлять конфигурацией/секретами, как мониторить и откатывать.

**Важно**: команду можно запускать **в любой момент**:
- **early** (до реализации) — чтобы избежать переделок из-за ограничений деплоя
- **retrofit** (после реализации) — как аудит готовности и план доводки до продакшена

## Предварительные условия

- Должен существовать `.pldf/concept.md`
- Должен существовать `.pldf/tech-stack.md`
- Желательно: `.pldf/architecture.md`
- Если чего-то не хватает — предложи выполнить соответствующие команды и объясни, почему они нужны для корректного плана деплоя.

## Цель этапа

Создать `.pldf/deployment.md`, который отвечает на вопросы:
- Где разворачиваем (провайдер/он‑прем/локально/магазины приложений)?
- Как выкатываем (CI/CD, стратегия релизов, миграции)?
- Какие окружения (dev/stage/prod) и как управляем конфигурацией/секретами?
- Как наблюдаем (логи/метрики/алерты) и как откатываемся?
- Какой бюджет/лимиты и критерии “готово к продакшену”?

## Рабочий процесс

0. **Загрузка контекста**:
   - Прочитай `.pldf/concept.md`, `.pldf/tech-stack.md`, `.pldf/project-context.md`
   - Если существует — прочитай `.pldf/architecture.md`
   - Выдели компоненты системы, данные/чувствительность, интеграции, требования к доступности.

1. **Определение режима (early/retrofit)**:
   - Если уже существует `.pldf/implementation-plan.md` или `.pldf/steps/` или заметен реализованный код — работай в режиме **retrofit** (аудит + план доработок).
   - Иначе — режим **early**.

2. **Сбор ограничений деплоя через диалог**:
   - Задавай вопросы **строго по одному**.
   - Минимум нужно выяснить: целевую среду, ограничения по бюджету/региону/комплаенсу, окружения, частоту релизов, требования к доступности.

3. **Сопоставление архитектуры с единицами деплоя**:
   - Перечисли deployment units (frontend/backend/workers/db/cache/storage/observability) и их зависимости.

4. **Выбор подхода к хостингу**:
   - Предложи 2–3 реалистичных варианта под стек и ограничения.
   - Выбери один вариант вместе со студентом (по одному вопросу за раз).

5. **Окружения и релизы**:
   - Опиши dev/stage/prod (минимум dev+prod).
   - Выбери стратегию релиза и отката.

6. **CI/CD**:
   - Опиши минимальный пайплайн: lint/test/build/publish/deploy.
   - Перечисли необходимые секреты **без значений**.

7. **Миграции и бэкапы**:
   - Опиши запуск миграций и план восстановления.

8. **Наблюдаемость**:
   - Минимум: логи + метрики + 2–3 алерта.

9. **Безопасность деплоя**:
   - TLS, секреты, least privilege, network boundaries.
   - Если есть ПДн/секреты — свяжи с `/pldf.security`.

10. **Сохранение артефакта**:
   - Загрузи шаблон `.pldf/templates/deployment-template.md`
   - Заполни и сохрани как `.pldf/deployment.md`
   - Добавь Decision Log в конец файла (дата/решение/причина/альтернативы/влияние)
   - Обнови `.pldf/project-context.md` (текущий этап = `deploy`, ссылка на `.pldf/deployment.md`)

11. **Если режим retrofit**:
   - Сделай gap-анализ: что нужно добавить/переделать для выбранного деплоя.
   - Сформируй список доработок и предложи включить их в план реализации (через `/pldf.plan`) или создать отдельные шаги.

## Выходные артефакты

- `.pldf/deployment.md`
- Обновленный `.pldf/project-context.md`

## Критерии завершения

- Ясно “где хостим” и “как деплоим”
- Описаны окружения и стратегия релиза/отката
- Понятно, как управляем конфигом/секретами, миграциями и бэкапами
- Есть минимальный план CI/CD и наблюдаемости
- Решения записаны в Decision Log

