---
description: Этап 3: Проектирование архитектуры, структуры проекта, модели данных и API контрактов
handoffs: 
  - label: Создать план реализации
    agent: pldf.plan
    prompt: Создай план реализации на основе архитектуры
scripts:
  sh:
  ps:
---

## Пользовательский ввод

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учитывать пользовательский ввод перед продолжением (если он не пустой).

## Описание

На этом этапе **PLDF (Progressive Learning Development Framework)** создается детальная архитектура проекта на основе:
- Концепции проекта
- Утвержденного дизайна UI
- Выбранного технологического стека

Этот этап определяет, **КАК** будет организован код и данные в проекте.

## Предварительные условия

- Должен существовать `.pldf/concept.md`
- Должен существовать `.pldf/ui-design.md`
- Должен существовать `.pldf/tech-stack.md`
- **Если файлы отсутствуют**, то предложи выполнить предыдущие этапы

## Цель этапа

Создать детальную архитектуру, включающую:
- Структуру директорий проекта
- Модель данных (на основе UI дизайна)
- API контракты (на основе UI дизайна)
- Внешние зависимости и интеграции
- Принципы организации кода

## Рабочий процесс

0. **Загрузка контекста**:
   - Прочитай все предыдущие артефакты:
     - `.pldf/concept.md`
     - `.pldf/ui-design.md`
     - `.pldf/tech-stack.md`
     - `.pldf/project-context.md`
   - **ВАЖНО**: Проанализируй HTML прототипы в `.pldf/ui-prototype/`:
     - Открой каждый HTML файл и извлеки информацию о:
       - Формах и полях ввода (какие данные отправляются)
       - Элементах отображения (какие данные получаются)
       - Действиях пользователя (какие операции выполняются)
       - Навигации между экранами

2. **Проектирование структуры проекта**:
   - На основе выбранного стека и подхода к организации (из этапа tech)
   - Создай детальную структуру директорий
   - Объясни назначение каждой директории

3. **Проектирование модели данных**:
   - На основе UI дизайна определи:
     - Какие сущности нужны (User, Product, Order, и т.д.)
     - Какие поля у каждой сущности
     - Связи между сущностями
     - Правила валидации
     - Состояния и переходы состояний (если применимо)
   - Создай `.pldf/data-model.md` с описанием моделей, структурой базы данных и связью между таблицами

4. **Проектирование API контрактов**:
   - На основе HTML прототипов и UI дизайна определи:
     - Какие эндпоинты нужны для каждого экрана (анализируй формы и действия в прототипах)
     - Методы HTTP (GET, POST, PUT, DELETE)
     - Структура запросов и ответов (извлеки из полей форм в прототипах)
     - Коды ошибок
   - **КРИТИЧНО**: Используй HTML прототипы как источник истины - если в прототипе нет элемента, не создавай для него эндпоинт
   - Создай директорию `.pldf/contracts/`
   - Для каждого эндпоинта создай файл с описанием контракта
   - Используй формат OpenAPI/Swagger, если возможно
   - Свяжи каждый контракт с соответствующим экраном из прототипа

4.5 **Объединение контрактов в один документ**
  - **Обязательно**: объедини все API контракты (Rest API) в один файл в нотации OpenAPI v.3 - `.pldf/contracts/openapi.yaml`

5. **Определение внешних зависимостей**:
   - Какие внешние сервисы/API нужны
   - Какие библиотеки потребуются
   - Какие инструменты разработки необходимы

6. **Создание документации архитектуры**:
   - Загрузи шаблон `.pldf/templates/architecture-template.md`
   - Заполни все разделы:
     - Структура проекта
     - Модель данных (ссылка на data-model.md)
     - API контракты (ссылки на contracts/)
     - Внешние зависимости
     - Принципы организации кода
   - Сохрани в `.pldf/architecture.md`

7. **Валидация архитектуры**:
   
   **ВАЖНО**: Перед сохранением файлов выполни полную валидацию архитектуры по следующему чек-листу:
   
   - [ ] **Все экраны из прототипов имеют соответствующие эндпоинты**
     - Для каждого экрана из HTML прототипов есть необходимые эндпоинты
     - Эндпоинты покрывают все действия пользователя на экране
     - **Если не выполнено**: создай недостающие эндпоинты
   
   - [ ] **Модель данных покрывает все требования UI**
     - Все данные, отображаемые в UI, есть в модели данных
     - Все данные, вводимые в UI, есть в модели данных
     - Модель данных соответствует структуре данных в прототипах
     - **Если не выполнено**: дополните модель данных
   
   - [ ] **Структура проекта соответствует выбранному стеку**
     - Структура директорий соответствует выбранным технологиям
     - Организация кода соответствует подходу из этапа tech
     - **Если не выполнено**: пересмотри структуру проекта
   
   - [ ] **API контракты соответствуют элементам из прототипов**
     - Все формы из прототипов имеют соответствующие POST/PUT эндпоинты
     - Все поля форм покрыты в структуре запросов
     - Все данные для отображения покрыты в структуре ответов
     - **Если не выполнено**: обнови API контракты
   
   - [ ] **Нет лишних эндпоинтов**
     - **КРИТИЧНО**: Созданы эндпоинты для элементов, которых нет в прототипах
     - Каждый эндпоинт соответствует конкретному экрану/действию
     - **Если есть лишние эндпоинты**: удали их или обоснуй необходимость
   
   - [ ] **Модель данных логична и нормализована**
     - Сущности имеют логичную структуру
     - Связи между сущностями определены
     - Нет избыточной нормализации или денормализации
     - **Если не выполнено**: пересмотри модель данных
   
   - [ ] **Архитектура расширяема**
     - Легко добавить новые функции
     - Структура поддерживает рост проекта
     - **Если не выполнено**: обсудите расширяемость архитектуры
   
   - [ ] **Документация архитектуры создана**
     - Файл `.pldf/architecture.md` создан и заполнен
     - Файл `.pldf/data-model.md` создан
     - API контракты созданы в `.pldf/contracts/`
     - **Если не выполнено**: создай документацию

   **Если валидация не пройдена:**
   - Укажи конкретные пункты, которые не выполнены
   - Предложи конкретные исправления
   - **НЕ ПЕРЕХОДИ** к следующему этапу до прохождения валидации
   
   **Если валидация пройдена:**
   - Подтвердите успешную валидацию
   - Переходите к записи решений в Decision Log

7.5. **Запись решений в Decision Log**:
   - Открой `.pldf/project-context.md` (создай из шаблона `.pldf/templates/project-context-template.md`, если не существует)
   - В разделе "Decision Log" → "История решений" добавь записи о:
     - Выборе архитектурного паттерна (Clean Architecture, Layered, Hexagonal, и т.д.) - почему выбран именно этот паттерн
     - Структуре директорий проекта - почему выбрана именно такая организация кода
     - Подходе к модели данных - как организована модель данных и почему
     - Выборе REST API вместо GraphQL (или наоборот) - почему выбран именно этот подход к API
     - Других важных архитектурных решениях (например, выбор паттернов управления состоянием, обработки ошибок)
   - Для каждого решения укажи:
     - **Дата**: текущая дата в формате YYYY-MM-DD
     - **Этап**: architecture
     - **Причина**: детальное обоснование решения с учетом выбранного технологического стека
     - **Альтернативы**: какие альтернативные подходы рассматривались и почему от них отказались
     - **Влияние на следующие этапы**: как это решение повлияет на план реализации (например, "Использование Clean Architecture потребует создания слоев в структуре проекта")
     - **Связанные решения**: ссылки на решения из этапа tech, которые повлияли на архитектурные решения (например, "Решение: Выбор Flutter для фронтенда" повлияло на структуру проекта)

8. **Обновление контекста**:
   - Обнови `.pldf/project-context.md` с информацией об архитектуре

10. **Отчет**:
   - Выведи пути к созданным файлам
   - Предложи перейти к следующему этапу (план реализации)

## Правила

- **СЛЕДУЙ** UI дизайну - не создавай эндпоинты, которых нет в дизайне
- **НАЧИНАЙ ПРОСТО** - избегай преждевременной оптимизации
- **ДОКУМЕНТИРУЙ** все решения с обоснованием
- Используй принципы из выбранного подхода организации кода

## Выходные артефакты

- `.pldf/architecture.md` - основная документация архитектуры
- `.pldf/data-model.md` - модель данных
- `.pldf/contracts/` - директория с API контрактами
- `.pldf/contracts/openapi.yaml` - директория с API контрактами
- `.pldf/project-context.md` - обновленный контекст проекта

## Подсказки и помощь

### Контекстные подсказки
При возникновении ошибок валидации система автоматически предложит подсказки. Например, если созданы контракты для элементов, которых нет в прототипе, система предложит проверить соответствие.

### Подсказки по запросу
Используйте команду `/hint` для получения наводящих вопросов:
- `/hint architecture` - подсказка для этапа архитектуры
- `/hint architecture api` - подсказка по API контрактам
- `/hint architecture data` - подсказка по модели данных

### Типичные ошибки и решения

**Архитектура не описана:**
- Подсказка: Опишите структуру проекта: как организованы компоненты, как они взаимодействуют, какие паттерны используются.
- Ресурсы: См. `.pldf/hints/resources.json` → `architecture_patterns`
- Паттерны: Изучите паттерны архитектуры в `.pldf/hints/patterns/clean-architecture/`:
  - `clean-architecture.md` - Clean Architecture (Uncle Bob)
  - `layered-architecture.md` - Многослойная архитектура
  - `hexagonal-architecture.md` - Hexagonal Architecture
  - `flutter-structure.md`, `react-structure.md`, `backend-structure.md` - структуры для конкретных технологий

**Модель данных не определена:**
- Подсказка: На основе UI прототипа определите структуру данных: какие сущности есть, какие у них поля, как они связаны.
- Ресурсы: См. `.pldf/hints/resources.json` → `data_modeling`

**Созданы контракты для элементов, которых нет в прототипе:**
- Подсказка: Проверьте прототип: каждый контракт должен соответствовать элементу интерфейса. Удалите лишние контракты.
- Ресурсы: См. `.pldf/hints/resources.json` → `api_design`
- Паттерны: Изучите паттерны работы с API в `.pldf/hints/patterns/data-fetching/rest-api.md`

## Следующий этап

После создания архитектуры переходите к `/pldf.plan` для разбивки на шаги реализации.