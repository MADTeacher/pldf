---
description: Этап 4: Создание плана реализации с разбивкой на последовательность шагов
handoffs: 
  - label: Начать реализацию
    agent: pldf.implement
    prompt: Начни реализацию с шага [N]
scripts:
  sh:
  ps:
---

## Пользовательский ввод

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учитывать пользовательский ввод перед продолжением (если он не пустой).

## Описание

На этом этапе **PLDF (Progressive Learning Development Framework)** проект разбивается на конкретные шаги реализации с использованием **инкрементального подхода**. Каждый запуск команды создает только **один новый шаг**, что позволяет работать в пределах контекстного окна даже для больших проектов со всеми функциями (P1, P2, P3).

Каждый шаг должен быть:
- Независимо тестируемым
- Имеющим четкие критерии завершения
- Содержащим описание того, что нужно сделать
- Включающим тесты для валидации
- Покрывающим хотя бы одну функцию из концепции проекта

## Предварительные условия

- Должны существовать все предыдущие артефакты:
  - `.pldf/concept.md`
  - `.pldf/ui-design.md`
  - `.pldf/tech-stack.md`
  - `.pldf/architecture.md`
  - `.pldf/data-model.md`
  - `.pldf/contracts/`
- Если файлы отсутствуют, предложи выполнить предыдущие этапы
- **ВАЖНО**: При планировании шага, который реализует функцию с дизайном или виджетами:
  - Проверь наличие сгенерированных файлов (HTML-прототипы, компоненты, виджеты)
  - Если такие файлы существуют, они **ОБЯЗАТЕЛЬНО** должны быть связаны в описании шага

## Цель этапа

Создать детальный план реализации инкрементально, который:
- Разбивает проект на логические шаги (по одному шагу за запуск)
- Определяет зависимости между шагами
- Включает тесты для каждого шага
- Позволяет отслеживать прогресс покрытия всех функций (P1, P2, P3)
- Оптимизирует использование контекстного окна через кэширование контекста
- Визуализирует прогресс планирования после каждого шага

## Рабочий процесс

**ВАЖНО**: Этот этап использует **инкрементальный подход к планированию**. Каждый запуск команды создает только **один новый шаг**, что позволяет работать в пределах контекстного окна даже для больших проектов.

0. **Проверка состояния планирования**:
   - Проверь существование `.pldf/memory/progress.json`
   - Если файл не существует:
     - Создай файл на основе шаблона `.pldf/templates/planning-state-template.json`
     - Установи режим работы: **`initial`**
   - Если файл существует:
     - Прочитай `plannedSteps` и `planningMetadata`
     - Определи режим работы:
       - **`initial`** (первый запуск): если `plannedSteps` пуст или отсутствует
       - **`incremental`** (последующие запуски): если `plannedSteps` не пуст

1. **Режим Initial (первый запуск)**:
   
   - **Проверка наличия артефактов**:
     - Если какой-либо обязательный файл отсутствует или поврежден:
       - Сообщи об ошибке
       - Укажи, какой файл отсутствует
       - Предложи выполнить предыдущие этапы для создания недостающих артефактов
       - **НЕ ПРОДОЛЖАЙ** планирование до устранения проблемы
   
   - Загрузи все предыдущие артефакты:
     - `.pldf/concept.md` (для понимания функций и приоритетов)
     - `.pldf/architecture.md` (для понимания структуры)
     - `.pldf/ui-design.md`, `.pldf/tech-stack.md`, `.pldf/data-model.md` (если существуют)
   
   - Проанализируй архитектуру и определи базовые шаги
   
   - **Проверь наличие файлов дизайна и сгенерированных файлов**:
     - Для функции, которую планируется реализовать в шаге, проверь наличие:
       - Файла с описанием дизайна UI (`.pldf/ui-design.md`)
       - HTML прототипов (`.pldf/ui-prototype/*.html`)
     - Если такие файлы существуют, мы должны на них явно ссылаться в описании шага
   
   - **Создай только первый шаг**:
     - Начни с базовой настройки проекта
     - Выбери шаг с наивысшим приоритетом (P1 → P2 → P3)
     - Убедись, что шаг не имеет зависимостей
     - **ВАЖНО**: Создавай только один шаг за запуск для соблюдения инкрементального подхода
     - **ВАЖНО**: Если для функции существуют файлы дизайна или сгенерированные файлы, включи ссылки на них в описание шага
   
   - Инициализируй `.pldf/memory/progress.json`:
     - Если файл не существует, создай на основе шаблона `.pldf/templates/planning-state-template.json`
     - Убедись, что структура включает:
       - `plannedSteps: []` на верхнем уровне
       - `planningMetadata` с полями: `lastPlannedStep`, `planningPhase`, `stepDependencies`, `progressMetrics`
     - Установи `planningPhase: "initial"`
     - Инициализируй `stepDependencies` с зависимостями первого шага
     - Инициализируй `progressMetrics`:
       - Подсчитай общее количество функций P1, P2, P3 из `concept.md`
       - Установи начальные значения: все функции непокрыты (covered: 0)
   
   - **Создай кэш контекста**: Создай `.pldf/planning-context-cache.md`:
     - Загрузи шаблон `.pldf/templates/planning-context-cache-template.md`
     - Замени токены-заполнители в квадратных скобках (например, [ДАТА], [Основные компоненты, слои, взаимодействия]) на конкретные значения из концепции проекта
     - Заполни кратким резюме архитектуры проекта:
       - Основные компоненты и их взаимодействие
       - Ключевые технические решения
       - Структура данных и модели
       - Основные паттерны и подходы
       - Основные зависимости между компонентами
     - Это будет использоваться в инкрементальном режиме для экономии контекста
   
   - Создай или обнови `.pldf/implementation-plan.md`:
     - Загрузи шаблон `.pldf/templates/implementation-plan-template.md`
     - Заполни заголовок и описание проекта
     - Добавь первый шаг в список шагов
     - Пока не заполняй полный список шагов - они будут добавляться инкрементально
   
   - Создай структуру первого шага:
     - Создай директорию `.pldf/steps/step-01-[name]/`
     - Создай файлы: `description.md`, `tasks.md`, `tests.md`, `validation.md`
     - Обнови `.pldf/memory/progress.json`: добавь шаг в `plannedSteps`
     - Обнови `planningMetadata.stepDependencies`
     - Обнови `planningMetadata.progressMetrics` с информацией о покрытии функций
   
   - Отобрази визуализацию прогресса планирования (см. раздел 6)

2. **Режим Incremental (последующие запуски)**:
   
   - Загрузи только необходимый контекст:
     - `.pldf/concept.md` (для понимания функций и приоритетов)
     - `.pldf/planning-context-cache.md` (для понимания структуры - используется вместо полного `architecture.md` для экономии контекста)
       - Если кэш не существует, загрузи `architecture.md` и создай кэш
       - Если кэш существует, но дата последнего обновления старше даты последнего изменения `architecture.md`, обнови кэш
     - `.pldf/implementation-plan.md` (для понимания уже запланированных шагов)
     - Список уже запланированных шагов из `.pldf/memory/progress.json` (`plannedSteps` и `planningMetadata.stepDependencies`)
   
   - **Определи следующий шаг** на основе:
     - Зависимостей из `planningMetadata.stepDependencies`
     - Уже запланированных шагов из `plannedSteps`
     - Приоритетов из `concept.md` (P1, P2, P3 - полный проект)
     - Алгоритма выбора (см. раздел 3)
   
   - **Проверь наличие файлов дизайна и сгенерированных файлов**:
     - Для функции, которую планируется реализовать в шаге, проверь наличие:
       - Файла с описанием дизайна UI (`.pldf/ui-design.md`)
       - HTML прототипов (`.pldf/ui-prototype/*.html`)
     - Если такие файлы существуют, мы должны на них явно ссылаться в описании шага
   
   - **Создай только ОДИН новый шаг**:
     - Создай директорию `.pldf/steps/step-[NN]-[name]/`
     - Создай файлы: `description.md`, `tasks.md`, `tests.md`, `validation.md`
     - **ОБЯЗАТЕЛЬНО**: Если для функции существуют файлы дизайна или сгенерированные файлы, включи ссылки на них в `description.md` и `tasks.md`
     - Обнови `.pldf/memory/progress.json`: добавь шаг в `plannedSteps`
     - Обнови `planningMetadata.stepDependencies` с новым шагом и его зависимостями
     - Обнови `planningMetadata.lastPlannedStep`
   
   - Обнови `.pldf/implementation-plan.md`, добавив новый шаг в список
   
   - Обнови метрики прогресса в `planningMetadata.progressMetrics`:
     - Определи, какие функции покрыты новым шагом (сопоставь с функциями из `concept.md`)
     - Обнови `p1Coverage`, `p2Coverage`, `p3Coverage`:
       - Увеличь `covered` для соответствующего приоритета
       - Вычисли `percentage = (covered / total) * 100`
     - Вычисли `overallProgress` как взвешенное среднее:
       - `overallProgress = (p1Coverage.percentage * 0.5 + p2Coverage.percentage * 0.3 + p3Coverage.percentage * 0.2)`
   
   - Отобрази визуализацию прогресса планирования (см. раздел 6)

3. **Определение следующего шага** (алгоритм выбора):
   
   - Найди все функции из `concept.md`, которые еще не покрыты запланированными шагами:
     - Учитывай все функции: P1, P2, P3
     - Проверь, какие функции уже покрыты шагами из `plannedSteps`
   
   - Для каждой непокрытой функции определи необходимые шаги на основе архитектуры (из кэша контекста)
   
   - Выбери шаг с наивысшим приоритетом (P1 → P2 → P3):
     - Сначала планируются функции P1 (критичные для решения "боли" ЦА)
     - Затем P2 (реализуются после критических функций)
     - Затем P3 (функции последней очереди)
   
   - Проверь, что все зависимости этого шага уже запланированы:
     - Проверь `planningMetadata.stepDependencies`
     - Убедись, что все зависимости присутствуют в `plannedSteps`
   
   - Если несколько шагов готовы к планированию, выбери первый по приоритету (P1 > P2 > P3)
   
   - Если нет шагов, готовых к планированию (все зависимости не выполнены), выбери шаг с наименьшим количеством непокрытых зависимостей
   
   - Если все функции покрыты, но остались технические шаги:
     - Планируй шаги интеграции, оптимизации, рефакторинга
     - Учитывай зависимости от уже запланированных шагов

4. **Создание структуры шага**:
   
   - Создай директорию `.pldf/steps/step-[NN]-[name]/`
     - **Формат номера**: `step-XX` где XX - двузначное число с ведущим нулем (01, 02, ..., 10, 11, ...)
     - **Имя шага**: используй kebab-case (например, `step-01-setup`, `step-02-user-model`)
     - Определи номер шага на основе количества уже запланированных шагов: `NN = plannedSteps.length + 1`
   
   - Создай файлы на основе шаблона `.pldf/templates/step-template.md`:
     - `description.md` - описание шага, что нужно сделать, почему этот шаг важен
     - `tasks.md` - список конкретных задач (чек-лист)
     - `tests.md` - описание тестов для этого шага (автоматические и ручные)
     - `validation.md` - критерии успешного завершения
   
   - В каждом файле укажи:
     - Номер и название шага
     - Зависимости от других шагов
     - Приоритет функции, которую покрывает шаг (P1, P2, P3)
     - Связь с функциями из концепции

5. **Кэширование контекста** (для оптимизации инкрементального режима):
   
   - После первого запуска (initial mode) создай файл `.pldf/planning-context-cache.md`:
     - Краткое резюме архитектуры проекта
     - Основные компоненты и их взаимодействие
     - Ключевые технические решения
     - Структура данных и модели
     - Основные паттерны и подходы
     - Основные зависимости между компонентами
   
   - В инкрементальном режиме используй кэш вместо полной загрузки `architecture.md`:
     - Загружай только `.pldf/planning-context-cache.md` для понимания структуры
     - Это значительно уменьшит объем загружаемого контекста
     - Кэш должен обновляться при значительных изменениях архитектуры
   
   - Формат кэша описан в шаблоне `.pldf/templates/planning-context-cache-template.md`

6. **Визуализация прогресса планирования**:
   
   - После создания каждого шага вычисляй и отображай:
     - Процент покрытия функций P1 запланированными шагами
     - Процент покрытия функций P2 запланированными шагами
     - Процент покрытия функций P3 запланированными шагами
     - Общий прогресс планирования
   
   - Формат отображения прогресса:
     ```
     Прогресс планирования:
     P1 функции: [X/Y] покрыты ([Z%]) ████████░░
     P2 функции: [X/Y] покрыты ([Z%]) ██████░░░░
     P3 функции: [X/Y] покрыты ([Z%]) ████░░░░░░
     Общий прогресс: [Z%]
     ```
   
   - Сохраняй метрики прогресса в `planningMetadata.progressMetrics`:
     - Обновляй после каждого нового шага
     - Вычисляй процент покрытия для каждого приоритета
     - Вычисляй общий прогресс как взвешенное среднее (P1 имеет больший вес)
   
   - Показывай прогресс в отчете после создания шага

7. **Валидация шага** (упрощенная для инкрементального режима):
   
   **ВАЖНО**: Перед сохранением файлов выполни валидацию **текущего шага** по следующему чек-листу:
   
   - [ ] **Новый шаг имеет полное описание**
     - Описание шага понятно и детально
     - Указано, почему этот шаг важен
     - **Если не выполнено**: дополни описание
   
   - [ ] **Новый шаг имеет задачи**
     - Список конкретных задач (чек-лист) определен
     - Задачи понятны и выполнимы
     - **Если не выполнено**: добавь задачи для шага
   
   - [ ] **Новый шаг имеет тесты**
     - Для шага определены тесты (автоматические или ручные)
     - Тесты проверяют критерии завершения шага
     - **Если не выполнено**: добавь тесты для шага
   
   - [ ] **Новый шаг имеет критерии завершения**
     - Четко определены критерии успешного завершения
     - Критерии проверяемы
     - **Если не выполнено**: уточни критерии завершения
   
   - [ ] **Зависимости логичны**
     - Все зависимости шага уже запланированы (присутствуют в `plannedSteps`)
     - Зависимости отражают реальную логику разработки
     - Граф зависимостей не содержит циклов (проверь при добавлении в `stepDependencies`):
       - Выполни обход графа зависимостей от текущего шага
       - Если найден путь обратно к текущему шагу, это цикл - исправь зависимости
     - **Если не выполнено**: пересмотри зависимости
   
   - [ ] **Шаг покрывает функции из концепции**
     - Шаг покрывает хотя бы одну функцию из концепции (P1, P2 или P3)
     - Связь с функциями из концепции явно указана
     - **Если не выполнено**: укажи, какие функции покрывает шаг
   
   - [ ] **Шаг разбит на управляемые части**
     - Шаг не слишком крупный (можно завершить за разумное время)
     - Шаг не слишком мелкий (имеет смысл)
     - **Если не выполнено**: пересмотри размер шага
   
   - [ ] **Шаг технически реализуем**
     - Шаг технически выполним
     - Учтены ограничения проекта
     - **Если не выполнено**: обсуди реализуемость шага
   
   **Если валидация не пройдена:**
   - Укажи конкретные пункты, которые не выполнены
   - Предложи конкретные исправления
   - **НЕ ПРОДОЛЖАЙТЕ** к следующему шагу до прохождения валидации
   
   **Если валидация пройдена:**
   - Подтвердите успешную валидацию шага
   - Переходите к проверке завершения планирования (раздел 8)

8. **Определение завершения планирования**:
   
   - После создания каждого шага проверяй покрытие функций из концепции:
     - Все ли функции P1 покрыты запланированными шагами?
     - Все ли функции P2 покрыты запланированными шагами?
     - Все ли функции P3 покрыты запланированными шагами?
   
   - Используй метрики из `planningMetadata.progressMetrics` для проверки
   
   - Если все функции (P1, P2, P3) покрыты:
     - Проверь, остались ли технические шаги (интеграция, оптимизация, рефакторинг)
     - Если технические шаги остались, продолжай планирование
     - Если все необходимые шаги запланированы:
       - Планирование завершено
       - Можно переходить к реализации
       - Предложи перейти к `/pldf.implement` для начала реализации
   
   - Если есть непокрытые функции:
     - Предложи продолжить планирование следующего шага
     - Покажи текущий прогресс планирования
     - Укажи, какие функции еще не покрыты

9. **Запись решений в Decision Log** (**только в initial mode или при важных изменениях**):
   - Открой `.pldf/project-context.md` (создай из шаблона `.pldf/templates/project-context-template.md`, если не существует)
   - В разделе "Decision Log" → "История решений" добавь записи о:
     - Подходе к инкрементальному планированию - почему выбран инкрементальный подход вместо планирования всех шагов сразу
     - Подходе к разбивке на шаги - почему выбрана именно такая последовательность шагов
     - Решениях о зависимостях между шагами - почему одни шаги должны выполняться перед другими
     - Выборе стратегии тестирования - какие типы тестов используются и почему
     - Решениях о размере шагов - почему шаги разбиты именно таким образом (не слишком крупные, не слишком мелкие)
     - Решении о кэшировании контекста - почему создан кэш для оптимизации инкрементального режима
   - Для каждого решения укажи:
     - **Дата**: текущая дата в формате YYYY-MM-DD
     - **Этап**: plan
     - **Причина**: обоснование решения с учетом архитектуры и требований проекта
     - **Альтернативы**: какие альтернативные подходы к планированию рассматривались (если были)
     - **Влияние на следующие этапы**: как это решение повлияет на реализацию (например, "Инкрементальное планирование гарантирует, что каждый шаг будет детально проработан в пределах контекстного окна")
     - **Связанные решения**: ссылки на решения из этапа architecture, которые повлияли на план (например, "Решение: Выбор Clean Architecture" повлияло на структуру шагов)

10. **Обновление контекста**:
   - Обнови `.pldf/project-context.md` с информацией о текущем состоянии планирования
   - Укажи количество запланированных шагов
   - Укажи текущий прогресс покрытия функций

11. **Отчет**:
    - Выведи путь к созданным файлам:
      - `.pldf/steps/step-[NN]-[name]/` - директория нового шага
      - `.pldf/implementation-plan.md` - обновленный план реализации
      - `.pldf/memory/progress.json` - обновленный файл прогресса
      - `.pldf/planning-context-cache.md` - кэш контекста (если создан)
    
    - Покажи информацию о новом шаге:
      - Номер и название шага
      - Описание шага
      - Зависимости шага
      - Покрываемые функции из концепции
    
    - Покажи текущий прогресс планирования:
      - Количество запланированных шагов
      - Визуализацию прогресса (из раздела 6)
      - Граф зависимостей (можно показать упрощенный граф для текущего шага)
    
    - **Если планирование завершено**:
      - Поздравь с завершением планирования
      - Предложи перейти к `/pldf.implement` для начала реализации
    
    - **Если планирование не завершено**:
      - Покажи, какие функции еще не покрыты
      - Предложи выполнить планирование следующего шага с помощью запуска команды `/pldf.plan`

## Правила

- **РАЗБИВАЙ** на мелкие, управляемые шаги
- **ОПРЕДЕЛЯЙ** зависимости явно
- **ТРЕБУЙ** тесты для каждого шага
- **ДОКУМЕНТИРУЙ** критерии завершения

## Структура шага

Каждый шаг должен содержать:
- **Номер и название**: step-01-setup, step-02-user-model, и т.д.
- **Описание**: Что делается на этом шаге
- **Задачи**: Конкретный список задач (чек-лист)
- **Тесты**: Как проверить, что шаг выполнен правильно
- **Валидация**: Критерии успешного завершения
- **Зависимости**: Какие шаги должны быть завершены до этого

## Выходные артефакты

- `.pldf/implementation-plan.md` - основной план реализации (обновляется инкрементально)
- `.pldf/steps/step-[NN]-[name]/` - директория с описанием нового шага
- `.pldf/memory/progress.json` - файл отслеживания прогресса (обновляется после каждого шага)
- `.pldf/planning-context-cache.md` - кэш контекста планирования (создается в initial mode)
- `.pldf/project-context.md` - обновленный контекст проекта

## Подсказки и помощь

### Контекстные подсказки
При возникновении ошибок валидации система автоматически предложит подсказки для создания плана реализации.

### Подсказки по запросу
Используй команду `/hint` для получения наводящих вопросов:
- `/hint plan` - подсказка для этапа планирования
- `/hint plan dependencies` - подсказка по зависимостям

### Типичные ошибки и решения

**Шаги реализации не определены:**
- Подсказка: Разбейте проект на конкретные шаги. Каждый шаг должен быть независимо тестируемым и иметь четкие критерии завершения.
- Ресурсы: См. `.pldf/hints/resources.json` → `planning`, `task_breakdown`

**Зависимости между шагами не определены:**
- Подсказка: Определите, какие шаги зависят от других. Базовые шаги (настройка проекта) должны идти первыми.
- Ресурсы: См. `.pldf/hints/resources.json` → `dependency_management`

## Следующий этап

- Если планирование завершено (все функции P1, P2, P3 покрыты шагами):
  - Переходи к `/pldf.implement` для начала реализации
  
- Если планирование не завершено:
  - Запусти команду `/pldf.plan` снова для планирования следующего шага
  - Система автоматически определит следующий шаг на основе зависимостей и приоритетов

