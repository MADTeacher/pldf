---
description: Команда проверки безопасности - аудит кода на соответствие стандартам OWASP и законодательству по персональным данным
scripts:
  sh:
  ps:
---

## Пользовательский ввод

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учитывать пользовательский ввод перед продолжением (если он не пустой).

## Правила диалога со студентом (обязательно)

- **Задавай вопросы строго по одному**: в каждом твоем сообщении должен быть **ровно 1 вопрос**, который требует ответа студента.
- **Не выдавай список вопросов заранее** (никаких длинных анкет/чек-листов вопросов за раз).
- Если нужен выбор, задай **один вопрос** и предложи **не больше 3–5 вариантов** (или попроси свободный ответ).
- **Дожидайся ответа** и только затем задавай следующий вопрос.
- Если ответ неполный — задай **один уточняющий вопрос**, а не несколько сразу.

## Описание

Эта команда **PLDF (Progressive Learning Development Framework)** выполняет комплексную проверку безопасности кода проекта на соответствие стандартам OWASP и законодательству по персональным данным. Команда поддерживает настраиваемый scope проверки для разных уровней сложности и образовательных целей.

## Предварительные условия

- **Должен существовать** реализованный код проекта (хотя бы частично)
- **Должен существовать** `.pldf/tech-stack.md` для понимания технологического стека
- **Должен существовать**`.pldf/architecture.md` для анализа архитектурных решений безопасности
- Если кода нет, предложи выполнить этап реализации (`/pldf.implement`)

## Цель команды

Провести комплексный security audit проекта:
- Проверить соответствие стандартам OWASP (Top 10 или ASVS)
- Проверить соответствие законодательству по персональным данным (152-ФЗ РФ по умолчанию)
- Выявить уязвимости в зависимостях
- Найти небезопасные паттерны в коде
- Выявить архитектурные проблемы безопасности
- Предоставить детальный отчет с рекомендациями по устранению проблем

## Параметры команды

Команда поддерживает следующие параметры:

- `--scope` - определяет, что проверять:
  - `basic` (по умолчанию) - OWASP Top 10 + законодательство ПД + зависимости + код
  - `full` - OWASP ASVS + Mobile/API (если применимо) + законодательство ПД + зависимости + код
  - `owasp-top10` - только OWASP Top 10
  - `asvs` - только OWASP ASVS
  - `mobile` - только Mobile Security (если проект мобильный)
  - `api` - только API Security (если есть API)
  - `privacy` - только законодательство по ПД
  - `dependencies` - только зависимости
  - `code` - только анализ кода
  - Можно комбинировать: `--scope asvs,mobile,privacy`

- `--jurisdiction` - определяет законодательство для проверки:
  - `152fz` (по умолчанию) - Федеральный закон №152-ФЗ "О персональных данных"
  - `gdpr` - General Data Protection Regulation (GDPR)
  - Можно комбинировать: `--jurisdiction 152fz,gdpr`

- `--skip-artifacts` - пропускает проверку существования артефактов проекта:
  - Если флаг не указан: обязательна проверка наличия артефактов
  - Если флаг указан: пропуск проверки, работа только с доступными артефактами
  - Полезно для проектов на ранних этапах или частичной документации

**Примеры использования:**
- `/pldf.security` - базовая проверка (Top 10 + 152-ФЗ + зависимости + код)
- `/pldf.security --scope full` - полная проверка (ASVS + Mobile/API + 152-ФЗ + зависимости + код)
- `/pldf.security --scope owasp-top10` - только OWASP Top 10
- `/pldf.security --scope asvs` - только OWASP ASVS
- `/pldf.security --scope privacy` - только законодательство по ПД
- `/pldf.security --jurisdiction gdpr` - проверка с GDPR вместо 152-ФЗ
- `/pldf.security --scope full --jurisdiction gdpr` - полная проверка с GDPR
- `/pldf.security --skip-artifacts` - базовая проверка без обязательных артефактов
- `/pldf.security --scope code --skip-artifacts` - только анализ кода без артефактов

## Рабочий процесс

### 1. Парсинг аргументов и определение scope

Проанализируй пользовательский ввод (`$ARGUMENTS`) для определения параметров:

**Определение scope:**
- Если `--scope` не указан: используй `basic` (Top 10 + privacy + dependencies + code)
- Если указан `--scope full`: используй ASVS вместо Top 10, плюс Mobile/API если применимо
- Если указан кастомный scope: используй только указанные проверки
- Разбери комбинированные значения (через запятую)

**Определение юрисдикции:**
- Если `--jurisdiction` не указан: используй `152fz` (152-ФЗ РФ)
- Если указан: используй указанную юрисдикцию
- Разбери мультиюрисдикцию (через запятую)

**Определение проверки артефактов:**
- Если `--skip-artifacts` указан: не проверяй существование артефактов, работай только с доступными
- Если не указан: обязательная проверка наличия артефактов, прерывание если их нет

### 2. Определение контекста проекта

**Проверка существования кода:**
- Проверь наличие файлов кода в проекте (не только `.pldf/`)
- Если кода нет и не указан `--skip-artifacts`, сообщи студенту и предложи выполнить `/pldf.implement`
- Если кода нет и указан `--skip-artifacts`, проинформируй и продолжай проверку без анализа кода

**Проверка существования артефактов (если не указан --skip-artifacts):**
- Проверь существование `.pldf/tech-stack.md`
- Проверь существование `.pldf/architecture.md`
- Проверь существование `.pldf/concept.md`
- Проверь существование `.pldf/data-model.md` (опционально)
- Если какие-то артефакты отсутствуют:
  - Сообщи студенту, какие артефакты не найдены
  - Предложи выполнить соответствующие команды PLDF для их создания
  - Спроси, продолжать ли проверку с доступными артефактами или прервать

**Загрузка артефактов:**
- Прочитай `.pldf/tech-stack.md`, если он существует
- Прочитай `.pldf/architecture.md`, если он существует
- Прочитай `.pldf/concept.md`, если он существует
- Прочитай `.pldf/data-model.md`, если он существует
- Для каждого отсутствующего артефакта отметь, что он недоступен для анализа

**Определение типа проекта:**
- Веб-приложение (если есть frontend/backend, веб или кроссплатформенные фреймворки)
- Мобильное приложение (если есть iOS/Android, React Native, Flutter и т.д.)
- API (если есть REST/GraphQL endpoints)
- Десктопное приложение (если есть Flutter, Qt, Electron, Tauri и т.д.)
- Комбинированный (несколько типов)

**Анализ технологического стека:**
- Определи языки программирования
- Определи фреймворки и библиотеки
- Определи базы данных
- Определи системы аутентификации/авторизации
- Определи способы хранения и передачи данных

### 3. Выполнение проверок согласно scope

#### 3.1. OWASP Top 10 проверки (если scope = basic или owasp-top10)

Для каждой категории A01-A10 проведи базовые проверки:

**A01:2021 - Broken Access Control**
- Проверь наличие authorization middleware/декораторов
- Проверь проверки ролей и прав доступа
- Поиск прямых ссылок на объекты (IDOR)
- Проверь CORS настройки
- Проверь проверки прав на уровне API endpoints

**A02:2021 - Cryptographic Failures**
- Проверь использование криптографических библиотек
- Проверь хранение паролей (должны быть хешированы, не в plaintext)
- Поиск hardcoded секретов (API ключи, пароли, токены)
- Проверь использование HTTPS/TLS
- Проверь шифрование чувствительных данных при хранении

**A03:2021 - Injection**
- Поиск SQL queries без параметризации (SQL injection)
- Поиск использования `eval()`, `exec()`, `innerHTML` (Code injection, XSS)
- Поиск NoSQL injection (MongoDB, и т.д.)
- Поиск Command injection (вызовы shell команд)
- Проверь валидацию и санитизацию входных данных

**A04:2021 - Insecure Design**
- Проверь наличие threat modeling
- Проверь архитектурные решения безопасности
- Проверь наличие rate limiting
- Проверь защиту от brute force атак

**A05:2021 - Security Misconfiguration**
- Проверь конфигурационные файлы на секреты
- Проверь настройки безопасности фреймворков
- Проверь настройки CORS, CSP headers
- Проверь настройки сессий и cookies
- Проверь настройки логирования (не логировать секреты)

**A06:2021 - Vulnerable and Outdated Components**
- Проверь наличие файлов зависимостей (package.json, requirements.txt, и т.д.)
- Предложи запустить сканеры уязвимостей (npm audit, pip-audit, и т.д.)
- Проверь версии зависимостей на устаревание

**A07:2021 - Identification and Authentication Failures**
- Проверь реализацию аутентификации
- Проверь наличие защиты от brute force
- Проверь политики паролей (минимальная длина, сложность)
- Проверь наличие MFA (если применимо)
- Проверь безопасность сессий (токены, cookies)

**A08:2021 - Software and Data Integrity Failures**
- Проверь целостность зависимостей (lock files, checksums)
- Проверь использование подписанных пакетов
- Проверь защиту от supply chain атак

**A09:2021 - Security Logging and Monitoring Failures**
- Проверь наличие логирования безопасности
- Проверь логирование аутентификации/авторизации
- Проверь логирование ошибок (без раскрытия секретов)
- Проверь мониторинг подозрительной активности

**A10:2021 - Server-Side Request Forgery (SSRF)**
- Поиск запросов к внешним URL на основе пользовательского ввода
- Проверь валидацию URL перед запросами
- Проверь использование whitelist для разрешенных доменов

#### 3.2. OWASP ASVS проверки (если scope = full или asvs)

Проведи более детальные проверки по OWASP ASVS Level 1 (базовый) или Level 2 (стандартный):

**V1: Architecture, Design and Threat Modeling**
- Проверь наличие threat modeling документации
- Проверь архитектурные решения безопасности
- Проверь разделение ответственности (separation of concerns)
- Проверь принцип наименьших привилегий

**V2: Authentication**
- Детальные проверки MFA (если требуется)
- Проверка политик паролей (детальные требования)
- Проверка session management (токены, refresh tokens, timeout)
- Проверка защиты от атак на аутентификацию

**V3: Session Management**
- Проверка генерации session ID (должны быть криптографически стойкие)
- Проверка timeout сессий
- Проверка invalidation сессий при logout
- Проверка защиты от session fixation

**V4: Access Control**
- Проверка RBAC/ABAC реализации
- Проверка принципа наименьших привилегий
- Проверка проверок прав на всех уровнях (UI, API, DB)
- Проверка защиты от privilege escalation

**V5: Validation, Sanitization and Encoding**
- Проверка валидации всех типов входных данных
- Проверка санитизации перед выводом (XSS защита)
- Проверка encoding для разных контекстов (HTML, URL, SQL, и т.д.)
- Проверка валидации файлов (если есть загрузка)

**V6-V14: Остальные категории ASVS**
- V6: Cryptographic Storage
- V7: Error Handling and Logging
- V8: Data Protection
- V9: Communications
- V10: Malicious Code
- V11: Business Logic
- V12: Files and Resources
- V13: API
- V14: Configuration

#### 3.3. Mobile Security проверки (если scope = mobile или full, и проект мобильный)

Проверки по OWASP Mobile Security Testing Guide:

- Проверка безопасного хранения данных на устройстве
- Проверка защиты от reverse engineering
- Проверка безопасной передачи данных
- Проверка безопасного использования криптографии
- Проверка безопасной аутентификации
- Проверка безопасной авторизации
- Проверка качества кода
- Проверка защиты от tampering
- Проверка безопасного использования внешних ресурсов
- Проверка конфиденциальности данных

#### 3.4. API Security проверки (если scope = api или full, и есть API)

Проверки по OWASP API Security Top 10:

- API1: Broken Object Level Authorization
- API2: Broken Authentication
- API3: Excessive Data Exposure
- API4: Lack of Resources & Rate Limiting
- API5: Broken Function Level Authorization
- API6: Mass Assignment
- API7: Security Misconfiguration
- API8: Injection
- API9: Improper Assets Management
- API10: Insufficient Logging & Monitoring

#### 3.5. Проверка законодательства по ПД (если включено в scope)

**Для 152-ФЗ РФ:**
- Поиск обработки персональных данных в коде (email, phone, passport, address, ФИО, и т.д.)
- Проверка наличия согласия на обработку ПД
- Проверка шифрования ПД при хранении (ст. 19)
- Проверка шифрования ПД при передаче (ст. 19)
- Проверка прав субъектов ПД (доступ, исправление, удаление) (ст. 14)
- Проверка логирования операций с ПД (ст. 18.1)
- Проверка уведомления Роскомнадзора (если требуется)
- Проверка политики конфиденциальности

**Для GDPR:**
- Проверка прав субъектов данных (access, rectification, erasure, portability)
- Проверка согласия на обработку (consent)
- Проверка Data Protection by Design and by Default
- Проверка Privacy Impact Assessment (если требуется)
- Проверка Breach notification процедур
- Проверка Data Processing Agreements

#### 3.6. Сканирование зависимостей (если включено в scope)

**Для npm проектов:**
- Предложи запустить `npm audit`
- Проверь наличие `package-lock.json`
- Проверь использование `npm ci` вместо `npm install` в CI/CD

**Для pip проектов:**
- Предложи запустить `pip-audit` или `safety check`
- Проверь наличие `requirements.txt` или `Pipfile.lock`
- Проверь использование виртуальных окружений

**Для других менеджеров пакетов:**
- Go: предложи использовать `govulncheck`
- Rust: предложи использовать `cargo audit`
- Java/Maven: предложи использовать OWASP Dependency-Check
- .NET: предложи использовать `dotnet list package --vulnerable`

**Для неучтенных стеков технологий:**
- Если проект использует технологический стек, не перечисленный выше, проведи поиск популярных пакетов/библиотек для сканирования зависимостей на уязвимости, используемых сообществом этого стека
- Найди инструменты, которые являются стандартом де-факто или официально рекомендованными для используемых языков и фреймворков
- Проверь наличие пакетов на официальных ресурсах сообщества (package registries, репозитории, документация)
- Предложи студенту установить и запустить найденный пакет для сканирования зависимостей
- Включи результаты сканирования и использованный инструмент в отчет по безопасности

#### 3.7. Анализ кода на небезопасные паттерны (если включено в scope)

**Поиск секретов в коде:**
- Hardcoded API ключи, пароли, токены
- Комментарии с секретами
- Конфигурационные файлы с секретами (не в .gitignore)
- Проверь использование переменных окружения

**Небезопасные паттерны:**
- Использование устаревших криптографических алгоритмов (MD5, SHA1, DES)
- Небезопасная генерация случайных чисел
- Небезопасное сравнение строк (timing attacks)
- Race conditions
- Небезопасная десериализация

**Недостаточная валидация:**
- Отсутствие валидации входных данных
- Недостаточная валидация (только на клиенте)
- Отсутствие rate limiting
- Отсутствие CSRF защиты

### 4. Генерация отчета

**Загрузка шаблона:**
- Загрузи шаблон `.pldf/templates/security-audit-template.md`
- Если шаблон не существует, используй структуру из плана

**Заполнение отчета:**

1. **Общая информация:**
   - Дата аудита (текущая дата)
   - Проверенная юрисдикция
   - Использованный scope
   - Тип проекта
   - Технологический стек

2. **Security Score:**
   - Рассчитай баллы по категориям:
     - OWASP_Score (0-1.0) - процент пройденных проверок
     - Privacy_Law_Score (0-1.0) - процент соответствия законодательству
     - Dependencies_Score (0-1.0) - процент безопасных зависимостей
     - Code_Security_Score (0-1.0) - процент безопасного кода
   - Рассчитай общий Security Score:
     ```
     Security Score = (
       OWASP_Score * 0.4 +
       Privacy_Law_Score * 0.3 +
       Dependencies_Score * 0.2 +
       Code_Security_Score * 0.1
     ) * 100
     ```
   - Определи оценку:
     - 90-100: Отлично
     - 75-89: Хорошо
     - 60-74: Удовлетворительно
     - <60: Требуется срочное улучшение

3. **OWASP Top 10 или ASVS результаты:**
   - Для каждой проверенной категории:
     - Статус (пройдено/не пройдено/частично)
     - Найденные проблемы с примерами кода (пути к файлам, номера строк)
     - Рекомендации по устранению
     - Ссылки на ресурсы для изучения

4. **Результаты проверки законодательства:**
   - Требования законодательства
   - Найденные несоответствия
   - Конкретные примеры кода с проблемами
   - Рекомендации по приведению в соответствие

5. **Анализ зависимостей:**
   - Список уязвимостей (если доступны результаты сканирования)
   - Устаревшие версии
   - Рекомендации по обновлению

6. **Безопасность кода:**
   - Найденные небезопасные паттерны
   - Секреты в коде (если найдены)
   - Проблемы с валидацией
   - Рекомендации по исправлению

7. **Архитектурные проблемы:**
   - Проблемы с аутентификацией/авторизацией
   - Проблемы с шифрованием данных
   - Проблемы с логированием/мониторингом
   - Рекомендации по улучшению архитектуры

8. **План действий:**
   - **Критичные проблемы** (немедленно):
     - Проблемы, которые могут привести к компрометации данных
     - Критичные уязвимости OWASP Top 10
     - Нарушения законодательства, которые могут привести к штрафам
   - **Важные проблемы** (в ближайшее время):
     - Проблемы, которые повышают риск атак
     - Средние уязвимости
     - Рекомендации по улучшению безопасности
   - **Рекомендации** (для улучшения):
     - Best practices для повышения уровня безопасности
     - Оптимизация существующих решений

**Сохранение отчета:**
- Сохрани отчет в `.pldf/security-audit.md`
- Убедись, что форматирование Markdown корректно
- Добавь ссылки на ресурсы из `.pldf/hints/resources.json`

### 5. Обновление контекста проекта

5.1. **Запись ключевых решений**:
   - Открой `.pldf/security-audit.md` (созданный на предыдущих шагах)
   - Загрузи шаблон `.pldf/templates/key-decisions-template.md`
   - Определи 1-3 САМЫХ критичных решения по безопасности:
     * Исправление критичных уязвимостей (если оценка High/Critical)
     * Архитектурные изменения для безопасности (если требуют рефакторинга)
     * Соответствие законодательству (GDPR/HIPAA/etc, если применимо)
   - Для каждого решения заполни:
     * **Причина**: 1-2 предложения, почему это решение критично для безопасности
     * **Влияние**: как повлияет на разработку, поддержку и архитектуру
   - Добавь заполненный раздел "Ключевые решения этапа" в конец `.pldf/security-audit.md`

5.2. **Обновление project-context.md**:
   - Обнови `.pldf/project-context.md`:
     - Установи текущий этап: "security"
     - Обнови статус этапа security audit: "Завершен"
     - Добавь ссылку на ключевые решения в `security-audit.md`
     - Добавь ссылку на отчет `.pldf/security-audit.md`
   - **ВАЖНО**: НЕ добавляй ключевые решения напрямую в `project-context.md`, только ссылки

### 6. Вывод результатов

Выведи студенту:
- Путь к отчету: `.pldf/security-audit.md`
- Общий Security Score и оценку
- Количество найденных проблем по категориям
- Топ-3 критичные проблемы (если есть)
- Рекомендации по следующим шагам

## Правила

- **БУДЬ КОНСТРУКТИВНЫМ** - не только указывай на проблемы, но и предлагай конкретные решения
- **ОБЪЯСНЯЙ ПРИЧИНЫ** - объясняй, почему проблема критична и как ее исправить
- **ПРИВОДИ ПРИМЕРЫ** - указывай конкретные файлы и строки кода с проблемами
- **ДАВАЙ РЕСУРСЫ** - ссылайся на документацию OWASP, законодательство, best practices
- **УЧИТЫВАЙ КОНТЕКСТ** - адаптируй проверки под технологический стек проекта

## Выходные артефакты

- `.pldf/security-audit.md` - детальный отчет по безопасности с Security Score (с ключевыми решениями в конце)
- `.pldf/project-context.md` - обновленный контекст проекта (только навигация и ссылки)

## Следующие шаги

После завершения security audit студент может:
- Исправить критичные проблемы безопасности
- Обновить уязвимые зависимости
- Привести код в соответствие законодательству
- Улучшить архитектуру безопасности
- Повторить проверку после исправлений

## Примеры использования

```
/pldf.security
/pldf.security --scope full
/pldf.security --scope owasp-top10
/pldf.security --scope asvs,privacy
/pldf.security --jurisdiction gdpr
/pldf.security --scope full --jurisdiction 152fz,gdpr
```

---

**Важно**: Security audit - это не разовая проверка, а регулярный процесс. Рекомендуется проводить проверку после каждого значимого изменения кода или перед релизом.


